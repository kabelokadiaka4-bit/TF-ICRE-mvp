# .github/workflows/build-and-push-service-images.yaml
name: Build & Push Service Images

on:
  push:
    branches:
      - main
    paths:
      - 'services/**'
      - 'infra/terraform/modules/cloud-run-service/**' # Rebuild if the module changes
  workflow_dispatch:
    inputs:
      service_name:
        description: 'Specific service to build (e.g., scoring-engine, tbml-engine, governance-engine) or ALL'
        required: true
        default: 'ALL'
        type: string

env:
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_PREFIX }}-${{ github.ref == 'refs/heads/main' && 'dev' || 'temp' }} # Adjust for env later
  GAR_LOCATION: ${{ vars.GCP_REGION }}
  GAR_REPOSITORY: 'tf-icre-images' # Name of your Artifact Registry repo

jobs:
  # Base job to get current project ID
  get-project-id:
    runs-on: ubuntu-latest
    outputs:
      project_id: ${{ steps.get_project.outputs.project_id }}
    steps:
      - name: Set dynamic GCP Project ID
        id: get_project
        run: |
          # In a multi-environment setup, this would be more sophisticated.
          # For simplicity, for now we assume 'dev' for pushes to main.
          # For workflow_dispatch, user input could determine the environment's project_id.
          echo "project_id=${{ vars.GCP_PROJECT_PREFIX }}-dev" >> $GITHUB_OUTPUT

  build-and-push:
    needs: get-project-id
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write' # For authentication to Google Cloud
    strategy:
      matrix:
        service:
          - scoring-engine
          - tbml-engine
          - governance-engine
    if: |
      github.event_name == 'push' || 
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.service_name == 'ALL' || github.event.inputs.service_name == matrix.service))

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Google Auth
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: Configure Docker to use Google Artifact Registry
        run: gcloud auth configure-docker "${{ env.GAR_LOCATION }}-docker.pkg.dev"

      - name: Build Docker Image
        id: build-image
        run: docker build -t "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ needs.get-project-id.outputs.project_id }}/${{ env.GAR_REPOSITORY }}/${{ matrix.service }}:${{ github.sha }}" ./services/${{ matrix.service }}

      - name: Push Docker Image
        run: docker push "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ needs.get-project-id.outputs.project_id }}/${{ env.GAR_REPOSITORY }}/${{ matrix.service }}:${{ github.sha }}"
